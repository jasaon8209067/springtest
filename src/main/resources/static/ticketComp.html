<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼ç¥¨çµå¸³é é¢</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- http://localhost:8080/ticketComp.html -->
    <h1>ğŸ« ç·šä¸Šè³¼ç¥¨ç³»çµ±</h1>
    <!-- æ´»å‹•è³‡è¨Šå€ -->
    <div class="event-info">
        <div class="event-left">
            <!-- <img src="thepalaceMuseum.png" alt="event-icon" class="event-image"> -->
            <img id="eventImage" src="" class="event-image">
        </div>
        <div class="event-center">
            <!-- <h5 class="event-title">ç”²å­è¬å¹´:åœ‹ç«‹æ•…å®®åšç‰©é™¢ç™¾å¹´é™¢æ…¶ç‰¹å±•</h5> -->
            <h5 id="eventTitle" class="event-title"></h5>
            <!-- <p>ç´°é …èªªæ˜:ç¥€èˆ‡æˆï¼šå¤ä»£å…µå™¨æ”»ç•¥</p> -->
            <p id="eventImage"></p>
            <!-- <p id="eventDetail"></p> -->
            <p id="eventDate"></p>
            <p id="eventLocation"></p>
        </div>
        <div class="event-right">
            <!-- æ—¥æ›† -->
            <div class="field">
                <label for="datePicker">é¸æ“‡æ—¥æœŸ: </label>
                <input id="datePicker" type="date" />
            </div>
            <!-- <select id="eventselecttime">
                <option selected>è«‹é¸æ“‡å ´æ¬¡æ™‚é–“</option>
                <option value="2024-07-01 10:00">2024-07-01 10:00</option>
                <option value="2024-07-01 14:00">2024-07-01 14:00</option>
                <option value="2024-07-02 10:00">2024-07-02 10:00</option>
                <option value="2024-07-02 14:00">2024-07-02 14:00</option>
            </select> -->
        </div>
    </div>

    <!-- è³¼ç¥¨å€ -->
    <div class="ticketzone">
        <h2>ç¥¨ç¨®é¸æ“‡</h2>
        <table class="tickets" style="border: 1px solid black; border-collapse:collapse ;">
            <tr>
                <th>ç¥¨ç¨®</th>
                <th>ç¥¨åƒ¹</th>
                <th>æ•¸é‡</th>
                <th>å‚™è¨»</th>
            </tr>
            <!-- <tr>
                <td>å…’ç«¥ç¥¨</td>
                <td>150</td>
                <td>
                    <select id="kidtickets">
                        <option selected>è«‹é¸æ“‡å¼µæ•¸</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </td>
                <td>é™0-12æ­²ä¹‹å…’ç«¥è³¼è²·ï¼Œå…¥å ´æ™‚éœ€å‡ºç¤ºç›¸é—œè­‰ä»¶</td>
            </tr>
            <tr>
                <td>æˆäººç¥¨</td>
                <td>300</td>
                <td>
                    <select id="abulttickets">
                        <option selected>è«‹é¸æ“‡å¼µæ•¸</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </td>
                <td></td>
            </tr>
            <tr>
                <td>æ•¬è€ç¥¨</td>
                <td>100</td>
                <td>
                    <select id="oldmantickets">
                        <option selected>è«‹é¸æ“‡å¼µæ•¸</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </td>
                <td>é™65æ­²ä»¥ä¸Šä¹‹æ°‘çœ¾è³¼è²·ï¼Œå…¥å ´æ™‚éœ€å‡ºç¤ºç›¸é—œè­‰ä»¶</td>
            </tr> -->
            <tbody>
                <!-- é€™è£¡æœƒè¢« JavaScript å‹•æ…‹å¡å…¥è³‡æ–™ -->
            </tbody>
        </table>

        <!-- å³ä¸‹è§’ç¸½è¨ˆå€ -->
        <div class="totalfee">
            <!-- å¯å¢åŠ é¡¯ç¤ºå„ç¥¨ç¨®å¼µæ•¸ -->
            <div>ç¥¨ç¨®: <span id="tickettype"></span></div>
            <div>ç¸½å…±å¼µæ•¸: <span id="toatltickets"></span></div>
            <!-- <div>å°è¨ˆ: <span id="subtotal"></span></div> -->
            <!-- <div>æœå‹™è²»: <span id="fee">NT$0</span></div> -->
            <hr>
            <div><strong>ç¸½é‡‘é¡: <span id="total"></span></strong></div>
            <div style="margin-top:10px"><button class="btn" id="checkoutBtn">å‰å¾€çµå¸³</button></div>
        </div>

        <div style="clear:both"></div>
        <div id="message"></div>
    </div>
    <footer>
        é å°¾å€ï¼ˆå¯æ”¾ç‰ˆæ¬Šã€è¯çµ¡è³‡è¨Šï¼‰
    </footer>

    <script>
        //ç­‰æ•´å€‹HTMLæ–‡ä»¶è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œï¼Œæ´»å‹•è³‡æ–™è¼‰å…¥
        document.addEventListener("DOMContentLoaded", () => {
            const eventId = 2;//è¨­å®šæ´»å‹•ID
            fetch(`/events/${eventId}`) //å‘¼å«å¾Œç«¯APIå–å¾—æ´»å‹•è³‡æ–™
                .then(response => response.json())
                .then(event => {
                    document.getElementById("eventTitle").textContent = event.name;
                    //document.getElementById("eventDetail").textContent = event.detail;
                    document.getElementById("eventDate").textContent = `å±•å‡ºæœŸé–“: ${event.startDate} ~ ${event.endDate}`;
                    document.getElementById("eventLocation").textContent = `æ´»å‹•åœ°é»: ${event.location}`;
                    document.getElementById("eventImage").src = `data:image/jpeg;base64,${event.image}`;

                    //è¨­å®šæ—¥æ›†å¯é¸æ—¥æœŸ(ç›®å‰æœ‰BUGå¯ä»¥é¸æ“‡å±•è¦½æœŸé–“å·²ç¶“çµæŸçš„æ—¥æœŸ)
                    const datePicker = document.getElementById("datePicker")

                    const startDate = new Date(event.startDate);
                    const endDate = new Date(event.endDate);

                    const bookingStart = new Date(startDate);
                    bookingStart.setDate(bookingStart.getDate() - 5);

                    //è¨­å®šä»Šæ—¥ï¼Œåªæ¯”æ—¥æœŸä¸æ¯”æ™‚é–“
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);  // é¿å…æ™‚é–“å•é¡Œ


                    const minDate = (today > bookingStart) ? today : bookingStart;

                    // è½‰æˆ date input å¯æ¥å—çš„ YYYY-MM-DD æ ¼å¼
                    function toYMD(date) {
                        return date.toISOString().slice(0, 10);
                    }
                    datePicker.min = toYMD(bookingStart);
                    datePicker.max = toYMD(endDate);

                    console.log("æœ€æ—©å¯é è¨‚æ—¥æœŸ:", datePicker.min);
                    console.log("æ´»å‹•çµæŸæ—¥æœŸ:", datePicker.max);
                    console.log("æœ€çµ‚å¯é¸æœ€å°æ—¥:", datePicker.min);
                    console.log("æœ€çµ‚å¯é¸æœ€å¤§æ—¥:", datePicker.max);

                })

        });



        //ç¥¨ç¨®è¼‰å…¥
        document.addEventListener("DOMContentLoaded", () => {
            fetch("/api/tickets")//å‘¼å«å¾Œç«¯APIå–å¾—ç¥¨ç¨®è³‡æ–™ /api/tickets
                .then(response => response.json())
                .then(data => {
                    const table = document.querySelector(".tickets");
                    // æ¸…é™¤èˆŠè³‡æ–™ï¼ˆä¿ç•™è¡¨é ­ï¼‰
                    table.innerHTML = `
                <tr>
                    <th>ç¥¨ç¨®</th>
                    <th>ç¥¨åƒ¹</th>
                    <th>æ•¸é‡</th>
                    <th>å‚™è¨»</th>
                </tr>
            `;
                    // const tbody = document.querySelector(".tickets tbody");
                    // tbody.innerHTML = "";//å¦‚æœæ²’æœ‰ç¥¨ç¨®è³‡æ–™ï¼Œè¡¨é ­ä¹Ÿæœƒè¢«æ¸…æ‰
                    data.forEach(ticket => {
                        table.innerHTML += `
                    <tr>
                        <td>${ticket.name}</td>
                        <td>${ticket.price}</td>
                        <td>
                            <select class="ticketselct" data-price="${ticket.price}">
                                <option selected>è«‹é¸æ“‡å¼µæ•¸</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </td>
                        <td>${ticket.remark || ''}</td>
                    </tr>
                `;
                    });
                })
                .catch(err => console.error("è®€å–ç¥¨ç¨®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", err));
        });

        //è¨ˆç®—ç¸½é‡‘é¡
        function calculateTotal() {
            //å–å¾—æ‰€æœ‰ç¥¨ç¨®çš„ä¸‹æ‹‰é¸å–®
            const ticketSelects = document.querySelectorAll(".ticketselct");
            let totalTickets = 0;
            let subtotal = 0;
            //é™£åˆ—å­˜å–æœƒå“¡é¸æ“‡çš„ç¥¨ç¨®
            let selectedTicketsText = [];
            //éæ­·æ¯å€‹ä¸‹æ‹‰é¸å–®ï¼Œè¨ˆç®—ç¸½ç¥¨æ•¸å’Œå°è¨ˆ
            ticketSelects.forEach(select => {
                const quantity = parseInt(select.value) || 0;//å–å¾—ç¥¨ç¨®æ•¸é‡ï¼Œå¦‚æœæ²’é¸æ“‡å‰‡ç‚º0
                const price = parseInt(select.getAttribute("data-price")) || 0;//å¾data-priceå±¬æ€§è®€å–å–®åƒ¹
                const ticketName = select.closest("tr").querySelector("td").textContent; //ç¥¨ç¨®åç¨±

                if (quantity > 0) {
                    selectedTicketsText.push(`${ticketName} ${quantity}å¼µ`);
                }

                totalTickets += quantity;
                subtotal += quantity * price;
            });
            //æ›´æ–°ç¸½ç¥¨æ•¸å’Œå°è¨ˆé¡¯ç¤º
            document.getElementById("tickettype").textContent = selectedTicketsText.join("/");
            document.getElementById("toatltickets").textContent = `ç¸½å…±${totalTickets}å¼µ`;
            // document.getElementById("subtotal").textContent = `NT$${subtotal}`;
            document.getElementById("total").textContent = `NT$${subtotal}`;

        }

        //ç›£è½ç¥¨ç¨®æ•¸é‡è®Šæ›´äº‹ä»¶ï¼Œé‡æ–°è¨ˆç®—ç¸½é‡‘é¡
        document.querySelector(".tickets").addEventListener("change", function (e) {
            //å¦‚æœè§¸ç™¼äº‹ä»¶çš„ç›®æ¨™å…ƒç´ (e.target)å…·æœ‰class="ticketselct"
            if (e.target.classList.contains("ticketselct")) {
                calculateTotal();//å°±å‘¼å«calculateTotalæ–¹æ³•è¨ˆç®—ç¸½é‡‘é¡
            }
        });

        



        
    </script>

</body>

</html>