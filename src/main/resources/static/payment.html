<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ¨¡æ“¬ä»˜æ¬¾é é¢ - é¡¯ç¤ºæ”¶åˆ°çš„ JSON</title>
    <style>
        body{font-family:Arial, "Noto Sans TC", sans-serif; padding:20px; background:#f7f7f7}
        .card{background:white; border-radius:8px; padding:18px; box-shadow:0 2px 8px rgba(0,0,0,0.08); max-width:900px; margin:0 auto}
        pre{background:#111; color:#dff; padding:12px; border-radius:6px; overflow:auto}
        .btn{display:inline-block; margin-right:8px; padding:10px 14px; border-radius:6px; cursor:pointer; border:none}
        .btn-confirm{background:#28a745; color:white}
        .btn-cancel{background:#dc3545; color:white}
        .small{font-size:0.9rem; color:#666}
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ” æ¨¡æ“¬ä»˜æ¬¾é é¢</h2>
        <p class="small">æ­¤é é¢æœƒé¡¯ç¤ºå¾é¸ç¥¨é å‚³éä¾†çš„ JSONï¼ˆä½¿ç”¨ <code>sessionStorage.checkoutData</code> å‚³éï¼‰ã€‚</p>

        <h3>æ”¶åˆ°çš„è³‡æ–™ï¼ˆJSONï¼‰</h3>
        <div id="jsonContainer">
            <p class="small">è®€å–ä¸­â€¦</p>
        </div>

        <h3>ç¥¨åˆ¸æ˜ç´°ï¼ˆå¯è¦–åŒ–ï¼‰</h3>
        <div id="summary"></div>

        <div style="margin-top:16px;">
            <button id="confirmBtn" class="btn btn-confirm">æ¨¡æ“¬ä»˜æ¬¾æˆåŠŸ</button>
            <button id="cancelBtn" class="btn btn-cancel">å–æ¶ˆä¸¦å›åˆ°é¸ç¥¨é </button>
        </div>

        <p class="small" style="margin-top:12px" id="status"></p>
    </div>

    <script>
        // è®€å– sessionStorage ä¸­çš„ checkoutData
        const raw = sessionStorage.getItem("checkoutData");
        const jsonContainer = document.getElementById("jsonContainer");
        const summary = document.getElementById("summary");
        const status = document.getElementById("status");

        if (!raw) {
            jsonContainer.innerHTML = "<p style='color:#cc0000'>æ²’æœ‰åœ¨ sessionStorage æ‰¾åˆ° checkoutDataã€‚è«‹å¾é¸ç¥¨é é€²å…¥ï¼ˆæœƒå°‡è³‡æ–™å­˜åœ¨ sessionStorageï¼‰ã€‚</p>";
            summary.innerHTML = '<p class="small">æ²’æœ‰ç¥¨åˆ¸è³‡æ–™ã€‚</p>';
        } else {
            try {
                const data = JSON.parse(raw);

                // é¡¯ç¤ºæ¼‚äº®æ ¼å¼åŒ–çš„ JSON
                const pretty = JSON.stringify(data, null, 2);
                jsonContainer.innerHTML = `<pre>${escapeHtml(pretty)}</pre>`;

                // é¡¯ç¤ºç¥¨åˆ¸æ¸…å–®
                if (Array.isArray(data.reserved) && data.reserved.length > 0) {
                    let html = '<table style="width:100%; border-collapse:collapse"><thead><tr><th style="text-align:left">ç¥¨ç¨®</th><th>å–®åƒ¹</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr></thead><tbody>';
                    data.reserved.forEach(item => {
                        const subtotal = (item.price || 0) * (item.quantity || 0);
                        html += `<tr>
                            <td style="padding:6px 0">${escapeHtml(item.name || ("ç¥¨ç¨®#" + (item.ticketTypeId || '?')))}</td>
                            <td style="text-align:center">${item.price || 0}</td>
                            <td style="text-align:center">${item.quantity || 0}</td>
                            <td style="text-align:right">${subtotal}</td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                    html += `<p style="text-align:right; font-weight:bold; margin-top:8px">ç¸½é‡‘é¡ï¼šNT$ ${Number(data.totalAmount || 0)}</p>`;
                    summary.innerHTML = html;
                } else {
                    summary.innerHTML = '<p class="small">ç¥¨åˆ¸é™£åˆ—ç‚ºç©ºã€‚</p>';
                }

                // é¡¯ç¤º expiresAtï¼ˆè‹¥æœ‰ï¼‰
                if (data.expiresAt) {
                    const expireDate = new Date(Number(data.expiresAt));
                    status.textContent = `ä¿ç•™åˆ°ï¼š${expireDate.toLocaleString()}ï¼ˆè‹¥è¶…éå‰‡éœ€å›è£œï¼‰`;
                }

            } catch (e) {
                jsonContainer.innerHTML = "<p style='color:#cc0000'>è§£æ checkoutData ç™¼ç”ŸéŒ¯èª¤ã€‚</p>";
                summary.innerHTML = "<p class='small'>è«‹ç¢ºèªè³‡æ–™æ ¼å¼ã€‚</p>";
                console.error(e);
            }
        }

        // ç°¡å–®çš„ HTML escapeï¼ˆç‚ºäº†å®‰å…¨é¡¯ç¤º JSONï¼‰
        function escapeHtml(str) {
            return String(str).replace(/[&<>"]/g, function (c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];
            });
        }

        // æ¨¡æ“¬ä»˜æ¬¾æˆåŠŸï¼šæ¨™è¨˜ sessionStorage ä¸­çš„ checkoutData.completed = true
        document.getElementById("confirmBtn").addEventListener("click", async () => {
            const raw2 = sessionStorage.getItem("checkoutData");
            if (!raw2) { alert("æ‰¾ä¸åˆ° checkoutData"); return; }
            const data = JSON.parse(raw2);
            // å°‡ completed å±¬æ€§è¨­ç‚º trueï¼ˆä»£è¡¨å·²ä»˜æ¬¾ï¼‰
            data.completed = true;
            data.paidAt = new Date().toISOString();
            sessionStorage.setItem("checkoutData", JSON.stringify(data));

            // ç¤ºç¯„ï¼šè‹¥ä½ è¦é€šçŸ¥å¾Œç«¯å»ºç«‹è¨‚å–®æˆ–ç¢ºèªä¿ç•™ï¼Œå¯åœ¨é€™è£¡å‘¼å« API
            // ä¾‹å¦‚ï¼š
            // await fetch('/api/orders/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });

            status.textContent = "ä»˜æ¬¾æˆåŠŸï¼ˆæ¨¡æ“¬ï¼‰ã€‚å·²æ¨™è¨˜ç‚ºå·²å®Œæˆã€‚";
            status.style.color = "#218838";

            // è·³è½‰å›é¸ç¥¨é æˆ–é¡¯ç¤ºè¨‚å–®é 
            // setTimeout(() => { window.location.href = 'ticketComp.html'; }, 1200);
        });

        // å–æ¶ˆï¼šç›´æ¥å›åˆ°é¸ç¥¨é ï¼ˆä¸æœƒè‡ªå‹•å›è£œï¼Œå¯¦éš›ç³»çµ±æ‡‰å‘¼å« /api/inventory/restoreï¼‰
        document.getElementById("cancelBtn").addEventListener("click", () => {
            // ä¹Ÿå¯ä»¥åœ¨é€™è£¡åˆªé™¤ sessionStorageï¼ˆè¦–æµç¨‹è€Œå®šï¼‰
            // sessionStorage.removeItem("checkoutData");
            window.location.href = "ticketComp.html";
        });
    </script>
</body>
</html>
